steps:

# Upload compiled pipeline to GCS
- name: 'gcr.io/cloud-builders/gsutil'
  args: ['cp', 'pipeline.tar.gz', 'settings.yaml', 'gs://${_GCS_LOCATION}/${_TAG}/']
  dir: 'kfp-cloudbuild/pipeline'
  id:   'Upload Pipeline to GCS'

# Deploy pipeline in KFP
- name: 'gcr.io/youtubelist-256522/kfp-util:latest'
  entrypoint: '/bin/sh'
  args: ['-c', '/builder/kubectl.bash;
         python3 helper.py deploy-pipeline
         --package_path=pipeline.tar.gz
         --version=\"$_TAG\"
         --experiment=\"$_EXPERIMENT_NAME\"
         --run']
  dir: 'kfp-cloudbuild/pipeline'
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=${_COMPUTE_ZONE}'
  - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLUSTER_NAME}'
  id:  'Deploy & Run Pipeline'
  waitFor: ['Compile Pipeline']

images:
- 'gcr.io/${_PROJECT_ID}/my_add:${_TAG}'
- 'gcr.io/${_PROJECT_ID}/my_divide:${_TAG}'